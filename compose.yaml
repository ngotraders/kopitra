services:
  servicebus:
    build:
      context: .
      dockerfile: servicebus-emulator/Dockerfile
    ports:
      - "7075:7075"
  gateway:
    build:
      context: .
      dockerfile: gateway/Dockerfile
    ports:
      - "8080:8080"
    environment:
      RUST_LOG: info
      EA_SERVICE_BUS_NAMESPACE: emulator
      EA_SERVICE_BUS_QUEUE: ea-admin
      EA_SERVICE_BUS_POLICY: emulator
      EA_SERVICE_BUS_KEY: emulator
      EA_SERVICE_BUS_EMULATOR_BASE_URL: http://servicebus:7075/
    depends_on:
      - servicebus
  management:
    build:
      context: .
      dockerfile: functions/Dockerfile
    environment:
      AzureWebJobsStorage: UseDevelopmentStorage=true
      DOTNET_ENVIRONMENT: Development
      FUNCTIONS_WORKER_RUNTIME: dotnet-isolated
      ManagementApi__Authentication__Mode: Development
      ManagementApi__ServiceBus__EmulatorBaseUrl: http://servicebus:7075/
      ManagementApi__ServiceBus__AdminQueueName: ea-admin
    depends_on:
      - gateway
      - servicebus
    ports:
      - "7071:7071"
  acceptance:
    build:
      context: .
      dockerfile: tests/acceptance/Dockerfile
    depends_on:
      - gateway
      - management
    environment:
      RUST_LOG: info
      GATEWAY_BASE_URL: http://gateway:8080
      MANAGEMENT_BASE_URL: http://management:7071/api
      OPS_BEARER_TOKEN: dev-token
  opsconsole-tests:
    build:
      context: .
      dockerfile: opsconsole/Dockerfile.integration
    depends_on:
      - gateway
      - management
    environment:
      OPS_MANAGEMENT_BASE_URL: http://management:7071/api
      OPS_GATEWAY_BASE_URL: http://gateway:8080
      MANAGEMENT_BASE_URL: http://management:7071/api
      GATEWAY_BASE_URL: http://gateway:8080
      OPS_BEARER_TOKEN: dev-token
      OPS_TENANT_ID: console
